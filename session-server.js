js const express = require('express'); const { default: makeWASocket, useMultiFileAuthState } = require('@whiskeysockets/baileys'); const qrcode = require('qrcode'); const fs = require('fs'); const path = require('path'); const app = express(); app.use(express.json()); app.use(express.static(__dirname)); let sock = null; const storePath = './session'; // Home page app.get('/', (req, res) => { res.send(<h1>SHYAM-MD Session Generator</h1> <p><a href=/qr>Click here for QR</a></p> <p>OR use POST /pair â†’ {number: 919xxxxxxxxx}</p>); }); // QR Route - with proper image app.get('/qr', async (req, res) => { if (sock) await sock.logout(); sock = null; const { state, saveCreds } = await useMultiFileAuthState(storePath); sock = makeWASocket({ auth: state, printQRInTerminal: false }); sock.ev.on('creds.update', saveCreds); sock.ev.on('connection.update', async (update) => { const { qr, connection } = update; if (qr) { const qrImage = await qrcode.toDataURL(qr); res.send(<h2>Scan this QR</h2> <img src=\( {qrImage} /> <br><br> <a href=/qr>New QR</a>); } if (connection === 'open') { res.send('Connected! Session saved.Download creds.json'); } if (connection === 'close') { sock = null; res.send('Connection closed. Try again'); } }); }); // Pairing Code Route app.post('/pair', async (req, res) => { let { number } = req.body; if (!number) return res.status(400).json({ error: Number is required }); number = number.replace(/\D/g, ''); if (!number.startsWith('+')) number = + \){number}; if (sock) await sock.logout(); sock = null; const { state, saveCreds } = await useMultiFileAuthState(storePath); sock = makeWASocket({ auth: state, printQRInTerminal: false }); sock.ev.on('creds.update', saveCreds); try { const code = await sock.requestPairingCode(number); res.json({ success: true, pairingCode: code }); } catch (err) { res.status(500).json({ error: err.message }); } }); // Download session app.get('/session', (req, res) => { const file = path.join(__dirname, storePath, 'creds.json'); if (fs.existsSync(file)) { res.download(file, 'creds.json'); } else { res.status(404).send('No session found. Scan QR first.'); } }); const PORT = process.env.PORTapp.listen(PORT, () => { console.log(Session generator running on port ${PORT}); console.log(Visit /qr); });
